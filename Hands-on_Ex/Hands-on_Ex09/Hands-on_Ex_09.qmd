---
title: "Hands-on_Ex_09"
author: "Cathy C."
date-modified: "last-modified" 
execute:
  echo: true 
  eval: true 
  warning: false 
  freeze: true  
---

# Modelling, Visualising and Analysing Network Data with R

## 1 Overview

Learning objectives include the following:

-   create graph object data frames, manipulate them using appropriate functions of *dplyr, lubridate, and tidygraph.*

-   build network graph visualisation using appropriate function of ***ggraph***

-   compute network geometrics using ***tidygraph***

-   build advanced gragh visualisation by incorporating the network ***geometrics***

-   build interactive network visualisation using ***visNetwork*** package

## 2 Getting started

Four network data modeling and visualisation packages will be installed and launched. They are **igraph, tidygraph, ggraph** and **visNetwork.** In addition, **tidyverse** and **lubridate** (specially designed to handle and wrangling time data) will be installed and launched, too.

## 3 The data

The data sets used in this hands-on exercise is from an oil exploration and extraction company. There are two data sets. One contains the nodes data and the other contains the edges (also know as link) data.

### 3.1 The edges data

*GAStech-email_edges.csv* which consists of two weeks of 9063 emails correspondances between 55 employees.

### 3.2 The nodes data

*GAStech_email_nodes.csv* which consist of the names, department and title of the 55 employees.

### 3.3 Importing network data from files

import *GAStech_email_node.csv* and *GAStech_email_edges-v2.csv* into RStudio environment by using `read_csv()` of **readr** package.

```{r}
pacman::p_load(readr, dplyr, lubridate, tidygraph, ggraph)
```

```{r}
GAStech_nodes <- read_csv("data/GAStech_email_node.csv")
GAStech_edges <- read_csv("data/GAStech_email_edge-v2.csv")
```

### 3.4 Reviewing the imported data

Next, we examine the structure of the data frame using *glimpse()* of **dplyr**.

```{r}
glimpse(GAStech_edges)
```

::::: goals
::: goals-header
Note
:::

::: goals-container
The output report of GAStech_edges above reveals that the *SentDate* is treated as â€œCharacterâ€ data type instead of *date* data type. It is important to change the data type of *SentDate* field back to â€œDateâ€â€ data type.
:::
:::::

### 3.5 Wrangling time

```{r}
GAStech_edges <- GAStech_edges %>%
  mutate(SendDate = dmy(SentDate)) %>%
  mutate(Weekday = wday(SentDate,
                        label = TRUE,
                        abbr = FALSE))
```

::::: goals
::: goals-header
Learn from the code
:::

::: goals-container
-   both *dmy()* and *wday()* are functions of **lubridate** package. [lubridate](https://r4va.netlify.app/cran.r-project.org/web/packages/lubridate/vignettes/lubridate.html) is an R package that makes it easier to work with dates and times.
-   *dmy()* transforms the SentDate to Date data type.
-   *wday()* returns the day of the week as a decimal number or an ordered factor if label is TRUE. The argument abbr is FALSE keep the daya spells in full, i.e.Â Monday. The function will create a new column in the data.frame i.e.Â Weekday and the output of *wday()* will save in this newly created field.
-   the values in the *Weekday* field are in ordinal scale.
:::
:::::

### 3.6 Reviewomg the revised date fields

Table below shows the data structure of the reformatted GAStech_edges data frame.

```{r, echo=FALSE}
glimpse(GAStech_edges)
```

### 3.7 Wrangling attributes

A close examination of *GAStech_edges* data.frame reveals that it consists of individual e-mail flow records. This is not very useful for visualisation. We will aggregate the individual by date, senders, receivers, main subject and day of the week.

```{r}
GAStech_edges_aggregated <- GAStech_edges %>%
  filter(MainSubject == "Work related") %>%
  group_by(source, target, Weekday) %>%
    summarise(Weight = n()) %>%
  filter(source!=target) %>%
  filter(Weight > 1) %>%
  ungroup()
```

::::: goals
::: goals-header
Learn from the code
:::

::: goals-container
-   four functions from **dplyr** package are used. They are: *filter()*, *group()*, *summarise()*, and *ungroup()*.
-   The output data.frame is called **GAStech_edges_aggregated**.
-   A new field called *Weight* has been added in GAStech_edges_aggregated.
:::
:::::

### 3.8 Reviewing the revised edges file

Table below shows the data structure of the reformatted GAStech_edges data frame.

```{r}
glimpse(GAStech_edges_aggregated)
```

## 4 Creating network objects using **tidygraph**

In this section, we will learn how to create a graph data model by using tidygraph package. It provides a tidy API for graph/network manipulation. While network data itself is not tidy, it can be envisioned as two tidy tables, one for node data and one for edge data. **tidygraph** provides a way to switch between the two tables and provides dplyr verbs for manipulating them. Furthermore it provides access to a lot of graph algorithms with return values that facilitate their use in a tidy workflow.

::::: goals
::: goals-header
Read
:::

::: goals-container
-   [Introducing tidygraph](https://www.data-imaginist.com/2017/introducing-tidygraph/)

-   [tidygraph 1.1 - A tidy hope](https://www.data-imaginist.com/2018/tidygraph-1-1-a-tidy-hope/)
:::
:::::

### 4.1 **The tbl_graph object**

Two functions of **tidygraph** package can be used to create network objects, they are:

-   [`tbl_graph()`](https://tidygraph.data-imaginist.com/reference/tbl_graph.html) creates a **tbl_graph** network object from nodes and edges data.

-   [`as_tbl_graph()`](https://tidygraph.data-imaginist.com/reference/tbl_graph.html) converts network data and objects to a **tbl_graph** network. Below are network data and objects supported by `as_tbl_graph()`

    -   a node data.frame and an edge data.frame,
    -   data.frame, list, matrix from base,
    -   igraph from igraph,
    -   network from network,
    -   dendrogram and hclust from stats,
    -   Node from data.tree,
    -   phylo and evonet from ape, and
    -   graphNEL, graphAM, graphBAM from graph (in Bioconductor).

### 4.2 **The dplyr verbs in tidygraph**

-   *activate()* verb from **tidygraph** serves as a switch between tibbles for nodes and edges. All dplyr verbs applied to **tbl_graph** object are applied to the active tibble.

![](images/image3.jpg){width="600"}

-   In the above the *.N()* function is used to gain access to the node data while manipulating the edge data. Similarly *.E()* will give you the edge data and *.G()* will give you the **tbl_graph** object itself.

### 4.3 **Using `tbl_graph()` to build tidygraph data model.**

In this section, we will use `tbl_graph()` of **tinygraph** package to build an tidygraphâ€™s network graph data.frame.

ðŸŽ¯ **Reference guide: [`tbl_graph()`](https://tidygraph.data-imaginist.com/reference/tbl_graph.html)**

```{r}
GAStech_graph <- tbl_graph(nodes = GAStech_nodes,
                           edges = GAStech_edges_aggregated, 
                           directed = TRUE)
```

### 4.4 **Reviewing the output tidygraphâ€™s graph object**

```{r}
GAStech_graph
```

::::: goals
::: goals-header
Review
:::

::: goals-container
-   The output above reveals that *GAStech_graph* is a tbl_graph object with 54 nodes and 4541 edges.
-   The command also prints the first six rows of â€œNode Dataâ€ and the first three of â€œEdge Dataâ€.
-   It states that the Node Data is **active**. The notion of an active tibble within a tbl_graph object makes it possible to manipulate the data in one tibble at a time.
:::
:::::

### 4.5 **Changing the active object**

The nodes tibble data frame is activated by default, but we can change which tibble data frame is active with the *activate()* function. Thus, if we wanted to rearrange the rows in the edges tibble to list those with the highest â€œweightâ€ first, we could use *activate()* and then *arrange()*. Visit the reference guide of activate() to find out more about the function.

```{r}
GAStech_graph %>%
  activate(edges) %>%
  arrange(desc(Weight))
```

## 5 Plotting static network graphs with **ggraph** package

[**ggraph**](https://ggraph.data-imaginist.com/) is an extension of **ggplot2**, making it easier to carry over basic ggplot skills to the design of network graphs.

As in all network graph, there are three main aspects to a **ggraph**â€™s network graph, they are: - [nodes](https://cran.r-project.org/web/packages/ggraph/vignettes/Nodes.html), - [edges](https://cran.r-project.org/web/packages/ggraph/vignettes/Edges.html) and - [layouts](https://cran.r-project.org/web/packages/ggraph/vignettes/Layouts.html).

Above have comprehensive discussion of each of this aspect of graph.

### 5.1 **Plotting a basic network graph**

The code chunk below uses [*ggraph()*](https://ggraph.data-imaginist.com/reference/ggraph.html), [*geom-edge_link()*](https://ggraph.data-imaginist.com/reference/geom_edge_link.html) and [*geom_node_point()*](https://ggraph.data-imaginist.com/reference/geom_node_point.html) to plot a network graph by using *GAStech_graph*.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggraph(GAStech_graph) +
  geom_edge_link() +
  geom_node_point()
```

::::: goals
::: goals-header
Laern from code
:::

::: goals-container
-   The basic plotting function is `ggraph()`, which takes the data to be used for the graph and the type of layout desired. Both of the arguments for `ggraph()` are built around *igraph*. Therefore, `ggraph()` can use either an *igraph* object or a *tbl_graph* object.
:::
:::::

### 5.2 **Changing the default network graph theme**

In this section, you will use [*theme_graph()*](https://ggraph.data-imaginist.com/reference/theme_graph.html) to remove the x and y axes.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
g <- ggraph(GAStech_graph) + 
  geom_edge_link(aes()) +
  geom_node_point(aes())

g + theme_graph(background = "#f1f4f5")
```

::::: goals
::: goals-header
Learn from the code
:::

::: goals-container
:::

-   **ggraph** introduces a special ggplot theme that provides better defaults for network graphs than the normal ggplot defaults. `theme_graph()`, besides removing axes, grids, and border, changes the font to Arial Narrow (this can be overridden).
-   The ggraph theme can be set for a series of plots with the `set_graph_style()` command run before the graphs are plotted or by using `theme_graph()` in the individual plots.
:::::

### 5.3 **Changing the coloring of the plot**

`theme_graph()` makes it easy to change the coloring of the plot.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
g <- ggraph(GAStech_graph) + 
  geom_edge_link(aes(colour = 'grey50', size = 0.4)) +
  geom_node_point(aes(colour = 'grey40'))

g + theme_graph(background = 'grey10',
                text_colour = 'white')
```

### 5.4 **Working with ggraphâ€™s layouts**

**ggraph** support many layout for standard used, they are: star, circle, nicely (default), dh, gem, graphopt, grid, mds, spahere, randomly, fr, kk, drl and lgl. Figures below and on the right show layouts supported by `ggraph()`.

![](images/image4.jpg){fig-align="centre" width="600"}

![](images/image5.jpg){fig-align="centre" width="600"}

### 5.5 **Fruchterman and Reingold layout**

Below plot the network graph using **Fruchterman and Reingold layout**.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
g <- ggraph(GAStech_graph, 
            layout = "fr") +
  geom_edge_link(aes()) +
  geom_node_point(aes())

g + theme_graph(background = "#f1f4f5")
```
::::: goals
::: goals-header
Laern from code
:::

::: goals-container
-   *layout* argument is used to define the layout to be used.
:::
:::::


### 5.6 **Modifying network nodes**

### 5.7 **Modifying edges**

## 6 Creating face graphs

## 7 Network metrics analysis

## 8 Building interactive network graph with visNetwork

## 9 Reference

# STUDY

```{r}
library(tidygraph)
create_ring(10)
```

```{r}
iris_clust <- hclust(dist(iris[1:4]))
iris_tree <- as_tbl_graph(iris_clust)
iris_tree
```

```{r}
iris_tree %>% activate(edges)
```

```{r}
as_tibble(iris_tree)
```

## The dplyr verbs

```{r}
iris_tree <- iris_tree %>% 
    activate(nodes) %>% 
    mutate(Species = ifelse(leaf, as.character(iris$Species)[label], NA)) %>% 
    activate(edges) %>% 
    mutate(to_setose = .N()$Species[to] == 'setosa')
iris_tree
```

`.N()` function is used to gain access to the node data while manipulating the edge data. Similarly `.E()` will give you the edge data and `.G()` will give you the `tbl_graph` object itself.

While one might expect all of `dplyr`s verbs to be supported in that manner, there is a clear limitation in the relational data structure that requires rows to maintain their identity. Thus, `summarise()` and `do()` are not allowed as there is no clear interpretation of how alterations on the node and edge data with these verbs should be interpreted. If these operations are required I suggest applying them to a tibble representation and then joining the result back in.

Speaking of joining, all joins from `dplyr` are supported. Nodes and edges are added and removed as required by the join. New edge data to be joined in must have a `to` and `from` column referencing valid nodes in the existing graph.

```{r}
library(dplyr)
iris_sum <- iris %>% 
    group_by(Species) %>% 
    summarise_all(mean) %>% 
    ungroup()
iris_tree <- iris_tree %>% 
    activate(nodes) %>% 
    left_join(iris_sum)
iris_tree
```

```{r}
library(ggraph)
gr1 <- create_notable('bull') %>% 
    mutate(name = letters[1:5])
gr2 <- create_ring(5) %>% 
    mutate(name = letters[4:8])

# Plot
gr1 %>% bind_graphs(gr2) %>% 
    ggraph(layout = 'kk') + 
    geom_edge_link() + 
    geom_node_point(size = 8, colour = 'steelblue') +
    geom_node_text(aes(label = name), colour = 'white', vjust = 0.4) + 
    ggtitle('Binding graphs') + 
    theme_graph()
```

```{r}
gr1 %>% graph_join(gr2) %>% 
    ggraph(layout = 'kk') + 
    geom_edge_link() + 
    geom_node_point(size = 8, colour = 'steelblue') +
    geom_node_text(aes(label = name), colour = 'white', vjust = 0.4) + 
    ggtitle('Joining graphs') + 
    theme_graph()
```
