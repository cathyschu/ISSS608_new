{
  "hash": "099ca337f0a0837ffa65e1a5bafdad8b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Hands-on_Ex05-1\"\nauthor: \"Cathy C.\"\ndate-modified: \"last-modified\" \nexecute:\n  echo: true \n  eval: true \n  warning: false \n  freeze: true \n---\n\n\n\n\n\n# **Creating Ternary Plot with R**\n\n## 1 Overview\n\nTernary plots are a way of displaying the **distribution** and **variability** of **three-part compositional data**. (For example, the proportion of aged, economy active and young population or sand, silt, and clay in soil.)\n\nThe display is a triangle with sides scaled from 0 to 1. Each side represents one of the three components. A point is plotted so that a line drawn perpendicular from the point to each leg of the triangle intersect at the component values of the point.\n\nIn this hands-on, I will build ternary plot programmatically using R for visualising and analysing population structure of Singapore. Here are the 4 steps:\n\n1.  Install and launch **tidyverse** and **ggtern** packages.\n2.  Derive three new measures using *`mutate()`* function of **dplyr** package.\n3.  Build a static ternary plot using *`ggtern()`* function of **ggtern** package.\n4.  Build an interactive ternary plot using *`plot-ly()`* function of **Plotly R** package.\n\n## 2 Install and Launch R Packages\n\n2 main R packages will be used.\n\n+--------------------------------------+-------------------------------------------------------------------------------------------------------------------------+\n| **R Package**                        | **Overview**                                                                                                            |\n+======================================+=========================================================================================================================+\n| [**ggtern**](http://www.ggtern.com/) | a ggplot extension that plots ternary diagrams. The package will be used to plot static ternary plots.                  |\n+--------------------------------------+-------------------------------------------------------------------------------------------------------------------------+\n| [**Plotply R**](https://plot.ly/r/)  | an R package for creating interactive web-based graphs via plotly's JavaScript graphing library, plotly.js.             |\n|                                      |                                                                                                                         |\n|                                      | The **plotly R** library contains the *ggplotly* function, which will convert **ggplot2** figures into a Plotly object. |\n+--------------------------------------+-------------------------------------------------------------------------------------------------------------------------+\n| **tidyverse**                        | selected tidyverse family packages: **readr**, **dplyr** and **tidyr** are installed and loaded.                        |\n+--------------------------------------+-------------------------------------------------------------------------------------------------------------------------+\n\n: {.striped .hover}\n\nVersion 3.2.1 of **ggplot2** will be installed instead of the latest version of **ggplot2**, because the current version of **ggtern** package is not compatible to the latest version of **ggplot2**.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(plotly, ggtern, tidyverse)\n```\n:::\n\n\n\n\n\n## 3 Data Preparation\n\n### 3.1 Data\n\nThe [Singapore Residents by Planning AreaSubzone, Age Group, Sex and Type of Dwelling, June 2000-2018](https://www.singstat.gov.sg/find-data/search-by-theme/population/geographic-distribution/latest-data) data will be used.\n\nFile name: *respopagsex2000to2018_tidy.csv*\n\n::: panel-tabset\n## Import data\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npop_data <- read_csv(\"data/respopagsex2000to2018_tidy.csv\")\nhead(pop_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 Ã— 5\n  PA         SZ                     AG      Year Population\n  <chr>      <chr>                  <chr>  <dbl>      <dbl>\n1 Ang Mo Kio Ang Mo Kio Town Centre AGE0-4  2011        290\n2 Ang Mo Kio Ang Mo Kio Town Centre AGE0-4  2012        270\n3 Ang Mo Kio Ang Mo Kio Town Centre AGE0-4  2013        260\n4 Ang Mo Kio Ang Mo Kio Town Centre AGE0-4  2014        250\n5 Ang Mo Kio Ang Mo Kio Town Centre AGE0-4  2015        260\n6 Ang Mo Kio Ang Mo Kio Town Centre AGE0-4  2016        250\n```\n\n\n:::\n:::\n\n\n\n\n\n## Prepare data\n\nUse `mutate()` function of **dplyr** package to derive 3 new measures, namely: young, active and old.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Deriving the young, economy active and old measures\nagpop_mutated <- pop_data %>%\n  mutate(`Year` = as.character(Year)) %>%\n  spread(AG, Population) %>% #turn the values in Population col into AG cols.\n  mutate(YOUNG = rowSums(.[4:8])) %>% #Age 0-24\n  mutate(ACTIVE = rowSums(.[9:16])) %>% #Age 25-64\n  mutate(OLD = rowSums(.[17:21])) %>% #Age >65\n  mutate(TOTAL = rowSums(.[22:24])) %>% #Age \n  filter(Year == 2018) %>%\n  filter(TOTAL >0)\n```\n:::\n\n\n\n\n:::\n\n::: column-margin\n#### ðŸŽ¯ **Useful mutate functions**\n\n-   [`+`](https://rdrr.io/r/base/Arithmetic.html), [`-`](https://rdrr.io/r/base/Arithmetic.html), [`log()`](https://rdrr.io/r/base/Log.html), etc., for their usual mathematical meanings\n\n-   [`lead()`](https://dplyr.tidyverse.org/reference/lead-lag.html), [`lag()`](https://dplyr.tidyverse.org/reference/lead-lag.html)\n\n-   [`dense_rank()`](https://dplyr.tidyverse.org/reference/row_number.html), [`min_rank()`](https://dplyr.tidyverse.org/reference/row_number.html), [`percent_rank()`](https://dplyr.tidyverse.org/reference/percent_rank.html), [`row_number()`](https://dplyr.tidyverse.org/reference/row_number.html), [`cume_dist()`](https://dplyr.tidyverse.org/reference/percent_rank.html), [`ntile()`](https://dplyr.tidyverse.org/reference/ntile.html)\n\n-   [`cumsum()`](https://rdrr.io/r/base/cumsum.html), [`cummean()`](https://dplyr.tidyverse.org/reference/cumall.html), [`cummin()`](https://rdrr.io/r/base/cumsum.html), [`cummax()`](https://rdrr.io/r/base/cumsum.html), [`cumany()`](https://dplyr.tidyverse.org/reference/cumall.html), [`cumall()`](https://dplyr.tidyverse.org/reference/cumall.html)\n\n-   [`na_if()`](https://dplyr.tidyverse.org/reference/na_if.html), [`coalesce()`](https://dplyr.tidyverse.org/reference/coalesce.html)\n\n-   [`if_else()`](https://dplyr.tidyverse.org/reference/if_else.html), [`recode()`](https://dplyr.tidyverse.org/reference/recode.html), [`case_when()`](https://dplyr.tidyverse.org/reference/case_when.html)\n\n#### **Grouped tibbles**\n\nBecause mutating expressions are computed within groups, they may yield different results on grouped tibbles. This will be the case as soon as an aggregating, lagging, or ranking function is involved. Compare this ungrouped mutate:\n\n```         \nstarwars %>%\n  select(name, mass, species) %>%\n  mutate(mass_norm = mass / mean(mass, na.rm = TRUE))\n```\n\n#### With the grouped equivalent:\n\n```         \nstarwars %>%\n  select(name, mass, species) %>%\n  group_by(species) %>%\n  mutate(mass_norm = mass / mean(mass, na.rm = TRUE))\n```\n\nThe former normalises `mass` by the global average whereas the latter normalises by the averages within species levels.\n:::\n\n## 4 Plot Ternary Diagram with R\n\n### 4.1 Plot a static ternary diagram\n\nUse ***ggtern()*** function of **ggtern** package to create a simple ternary plot:\n\n::: panel-tabset\n## Classic\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\n#Building the static ternary plot\nggtern(data=agpop_mutated, \n       aes(x=YOUNG,y=ACTIVE, z=OLD)) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](Hands-on_Ex05_1_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## theme_rgbw()\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\nggtern(data = agpop_mutated, \n       aes(\n         x = YOUNG, y = ACTIVE, z = OLD\n)) +\n  geom_point() +\n  labs(title = \"Popultation structure, 2015\") +\n  theme_rgbw()\n```\n\n::: {.cell-output-display}\n![](Hands-on_Ex05_1_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Interactive\n\nUse `plot_ly()` to create an interactive plot.:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\n# Function for creating annotation object too\nlabel <- function(txt) {\n  list(\n    text = txt, \n    x = 0.1, y = 1, #Position of the annotation in the plot\n    ax = 0, ay = 0, #annotation has no arrow\n    xref = \"paper\", yref = \"paper\",  #Positioning is relative to the entire figure, not data points\n    align = \"center\",\n    font = list(family = \"Calibri\", size = 15, color = \"white\"),\n    bgcolor = \"#000000\", # Background color of the annotation box (light gray)\n    bordercolor = \"black\", \n    borderwidth = 2\n  )\n}\n\n# Function for creating axis formatting too\naxis <- function(txt) {\n  list(\n    title = txt, tickformat = \".0%\", tickfont = list(size = 10)\n  )\n}\n\nternaryAxes <- list(\n  aaxis = axis(\"Young\"), \n  baxis = axis(\"Active\"), \n  caxis = axis(\"Old\")\n)\n\n# Initiate a plotly visualization\nplot_ly(\n  agpop_mutated, \n  a = ~YOUNG, \n  b = ~ACTIVE, \n  c = ~OLD, \n  color = I(\"black\"), \n  type = \"scatterternary\"\n) %>%\n  layout(\n    annotations = label(\"Ternary Markers\"), \n    ternary = ternaryAxes\n  )\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"plotly html-widget html-fill-item\" id=\"htmlwidget-57c65c6b293334667fbd\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-57c65c6b293334667fbd\">{\"x\":{\"visdat\":{\"7c27be26b7\":[\"function () \",\"plotlyVisDat\"]},\"cur_data\":\"7c27be26b7\",\"attrs\":{\"7c27be26b7\":{\"a\":{},\"b\":{},\"c\":{},\"color\":[\"black\"],\"alpha_stroke\":1,\"sizes\":[10,100],\"spans\":[1,20],\"type\":\"scatterternary\"}},\"layout\":{\"margin\":{\"b\":40,\"l\":60,\"t\":25,\"r\":10},\"annotations\":[{\"text\":\"Ternary Markers\",\"x\":0.10000000000000001,\"y\":1,\"ax\":0,\"ay\":0,\"xref\":\"paper\",\"yref\":\"paper\",\"align\":\"center\",\"font\":{\"family\":\"Calibri\",\"size\":15,\"color\":\"white\"},\"bgcolor\":\"#000000\",\"bordercolor\":\"black\",\"borderwidth\":2},{\"text\":\"Ternary Markers\",\"x\":0.10000000000000001,\"y\":1,\"ax\":0,\"ay\":0,\"xref\":\"paper\",\"yref\":\"paper\",\"align\":\"center\",\"font\":{\"family\":\"Calibri\",\"size\":15,\"color\":\"white\"},\"bgcolor\":\"#000000\",\"bordercolor\":\"black\",\"borderwidth\":2},{\"text\":\"Ternary Markers\",\"x\":0.10000000000000001,\"y\":1,\"ax\":0,\"ay\":0,\"xref\":\"paper\",\"yref\":\"paper\",\"align\":\"center\",\"font\":{\"family\":\"Calibri\",\"size\":15,\"color\":\"white\"},\"bgcolor\":\"#000000\",\"bordercolor\":\"black\",\"borderwidth\":2}],\"ternary\":{\"aaxis\":{\"title\":\"Young\",\"tickformat\":\".0%\",\"tickfont\":{\"size\":10}},\"baxis\":{\"title\":\"Active\",\"tickformat\":\".0%\",\"tickfont\":{\"size\":10}},\"caxis\":{\"title\":\"Old\",\"tickformat\":\".0%\",\"tickfont\":{\"size\":10}}},\"hovermode\":\"closest\",\"showlegend\":false},\"source\":\"A\",\"config\":{\"modeBarButtonsToAdd\":[\"hoverclosest\",\"hovercompare\"],\"showSendToCloud\":false},\"data\":[{\"a\":[1330,5880,5430,4930,1960,3580,2170,4570,1150,6130,2030,19180,7100,11210,9260,9430,8710,1440,6480,8280,7210,1550,6830,2990,4350,4010,2770,3430,5500,6780,3170,420,3020,260,1670,1720,2380,1810,800,3100,3880,2470,1940,2810,3780,5610,2050,8740,8520,1130,8270,6600,5980,1970,1860,2860,3410,1760,1650,2960,120,620,6520,10920,10900,10000,6620,12980,3160,6320,3640,3850,1840,1420,1960,130,30,130,90,8490,7330,2990,6460,1200,6550,10340,7850,6780,7450,3670,12190,120,150,4840,3930,5670,4940,8920,13710,19300,11640,2690,20320,7740,2560,1490,2500,150,2360,2110,2940,10,630,2410,6740,2770,20,30,980,360,270,40,370,7380,1110,860,2850,200,100,10,120,180,2440,1230,10,4220,570,0,9370,16820,2440,11730,16130,70,15940,5790,16050,1380,2930,3090,2350,180,4060,3650,110,170,1140,800,10,50,30,2290,960,720,480,320,60,210,600,0,650,30,270,50,470,260,90,4440,9320,2570,8230,1920,550,14340,6670,17850,18300,18460,2460,3770,5230,8460,4580,3820,0,10,740,510,170,10740,35900,22030,470,1650,2870,370,970,3070,2360,1850,1690,1530,2380,2240,1330,7210,2760,710,230,12150,3200,10730,31770,14070,8330,2330,5470,240,7480,1190,320,17730,9990,13540],\"b\":[2770,16970,15700,13300,3620,9600,4650,12580,2410,14580,4360,48300,15570,27340,19350,23190,22610,3560,17330,18000,16800,3280,16220,8330,9350,9370,5900,8010,11410,16640,7850,910,8660,610,3750,4840,6340,5330,1980,7070,10570,7080,5600,7550,9150,14000,4050,16960,19480,2260,15840,12220,12530,3360,3510,4930,5870,3670,3120,5930,370,820,12890,19140,19690,20320,15130,25120,7860,17070,9420,8970,3380,3390,3480,510,190,510,450,24310,18320,7710,16440,2860,15680,28800,18270,15160,19160,8080,26570,280,540,11110,9510,15270,11830,17800,32920,40760,22960,4960,41410,21590,7150,4930,6980,530,6240,5790,6670,40,1250,5500,15070,5990,200,110,2210,690,580,160,960,19220,2050,1490,5370,390,250,100,270,890,6440,3910,230,8830,1290,0,18550,33140,4480,21430,28870,140,28320,10780,28590,4320,6350,7460,7450,520,8820,9150,140,460,2730,1970,70,210,70,6810,2160,1820,1130,890,140,780,1710,100,1980,90,950,160,1180,1140,140,8480,18720,5520,15810,3590,1000,26160,12930,31820,36400,37430,4880,7790,15440,21410,9730,9720,100,120,1790,1190,390,24500,81520,48300,1090,4050,5320,810,2100,7410,5650,4810,4900,4220,6170,6730,3040,16770,8270,1470,430,21000,7640,20770,58380,24020,18380,6640,9140,550,18000,2350,850,34470,25550,34480],\"c\":[730,5480,5960,4780,1200,3360,1300,4800,640,4270,850,15150,3190,9530,5460,5850,7230,1560,4920,3990,5520,260,3600,1990,1340,2100,1430,1660,2110,3400,3240,100,3510,250,970,1840,2780,2350,410,1960,3510,3120,2260,2450,2740,3320,620,2800,3930,430,2220,1890,3590,1070,880,1320,1390,1060,860,1880,110,50,2100,2830,2180,3370,3510,3350,2830,6130,2780,2930,670,1240,750,220,0,30,70,7240,5530,1600,5170,710,2830,7180,4180,3810,5880,2470,5540,10,220,3350,1800,4550,3170,3500,8240,5650,4050,740,7140,6700,2530,2560,2500,160,2150,1830,1460,10,250,1490,5720,1590,20,10,540,130,150,30,280,5760,750,480,1000,140,100,0,70,450,2070,2200,50,1600,300,170,2650,6040,340,3060,2950,40,4160,910,2870,1760,2040,3020,3410,140,2150,3040,0,20,540,510,20,50,0,2700,390,300,320,260,0,300,520,40,830,0,120,40,530,540,0,1260,2500,400,2170,720,180,3250,1590,4160,5990,5410,1210,2360,4480,7430,1970,2700,20,10,200,100,150,5150,17670,9660,180,800,1240,250,580,3120,2010,1310,1710,1810,2260,2350,1040,4900,3260,260,70,2830,2050,3080,6910,3080,4090,1570,700,150,3560,690,210,4740,5330,7770],\"type\":\"scatterternary\",\"mode\":\"markers\",\"marker\":{\"color\":\"rgba(0,0,0,1)\",\"line\":{\"color\":\"rgba(0,0,0,1)\"}},\"textfont\":{\"color\":\"rgba(0,0,0,1)\"},\"line\":{\"color\":\"rgba(0,0,0,1)\"},\"frame\":null}],\"highlight\":{\"on\":\"plotly_click\",\"persistent\":false,\"dynamic\":false,\"selectize\":false,\"opacityDim\":0.20000000000000001,\"selected\":{\"opacity\":1},\"debounce\":0},\"shinyEvents\":[\"plotly_hover\",\"plotly_click\",\"plotly_selected\",\"plotly_relayout\",\"plotly_brushed\",\"plotly_brushing\",\"plotly_clickannotation\",\"plotly_doubleclick\",\"plotly_deselect\",\"plotly_afterplot\",\"plotly_sunburstclick\"],\"base_url\":\"https://plot.ly\"},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n:::\n",
    "supporting": [
      "Hands-on_Ex05_1_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"../../site_libs/plotly-binding-4.10.4/plotly.js\"></script>\n<script src=\"../../site_libs/typedarray-0.1/typedarray.min.js\"></script>\n<script src=\"../../site_libs/jquery-3.5.1/jquery.min.js\"></script>\n<link href=\"../../site_libs/crosstalk-1.2.1.9000/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/crosstalk-1.2.1.9000/js/crosstalk.min.js\"></script>\n<link href=\"../../site_libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/plotly-main-2.11.1/plotly-latest.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}